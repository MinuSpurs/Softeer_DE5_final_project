# 172 노선 혼잡 예측 프로토타입

## 개요
- **목표:** 종로구를 통과하는 172번 버스의 6월 1–21일 데이터를 학습해 6월 22–29일 **정류장×시간** 단위 승·하차 인원을 예측하고, **버스당 탑승 인원** 기반으로 혼잡도를 산정, **추가 배차 수**를 제안. (1차 목표, 2차 목표는 과배차된 버스 수를 예측)
- **핵심 산출물:**  
  - `172_LSTM_preds_정류장별_시간별_승하차_예측.csv`  
  - `172_LSTM_preds_정류장별_시간별_승하차_예측_혼잡도+추가배차.csv`

## 데이터
- 원천
  - `.../2025년_버스노선별_정류장별_시간대별_승하차_인원_정보(06월)_utf8.csv` (월집계, 시간대별 승·하차 인원)
  - `.../tpss_sta_route_hturn_merged.csv` (일별·시간대별 정류장 통과 운행횟수)
  - `.../서울시 버스노선 기본정보 항목정보_utf8.csv` (노선명, 노선ID 매핑)
  - `.../서울시 노선 정류장마스터 정보_utf8.csv` (정류장 순서, 링크 구간거리)
- 중간 가공 산출물
  - `172_시간대별_정류장_노선_추정승하차+운행횟수+순서+링크거리.csv`  
    (172만 필터, 정류장 순서/링크거리(정류장 사이의 거리) 조인, 월집계 → 일자 배분, **운행횟수 비율로 일자·시간 분배**, 링크거리 결측 시 **노선 평균거리**로 대체)

## 파이프라인 개요
1) **필터링 & 매핑**
   - 노선명 `172`만 추출, `노선명→노선ID` 매핑
2) **월→일 분배**
   - `운행횟수`를 시간대별 비율로 정규화
3) **정류장 정렬 & 링크거리**
   - `정류장_순서`로 정렬, 링크거리 결측은 노선 평균으로 대체(1번 정류장=0)
4) **시뮬레이션 준비**
   - 각 시간블록에서 **통과버스수**(=운행횟수), **총수요** 계산
   - **버스당 탑승예측 = 총수요 / 통과버스수** 
5) **규칙 적용**
   - 음수 예측값은 `0`으로 **하단 클리핑**
   - **말단 정류장**(루프의 마지막)은 승객 **0 강제**
6) **혼잡·배차 로직**
   - 버스 정원(33명) 기준 **1.5배 초과 시 혼잡** → 서울시 버스 혼잡도 공식 통계 사용
   - `필요_총버스 = ceil(총수요 / (33 * 1.5))`
   - `추가_배차 = max(0, 필요_총버스 - 통과버스수)`
   - `개선후_버스당 = 총수요 / max(통과버스수 + 추가_배차, 1)`
   - 개선후 혼잡도 다시 산정

## 모델
- **모델:** 단방향 LSTM (Keras, TF 2.19.0)
- **학습 데이터:** 2025-06-01 ~ 2025-06-21
- **검증/예측:** 2025-06-22 ~ 2025-06-29
- **입력 특징 예시:**
  - 이전 시간의 승·하차 시계열(window)
  - 정류장 one-hot/embedding 또는 순서
  - (옵션) 요일/시간 인덱스, 링크거리, 누적 탑승 등 파생변수
- **출력:** 정류장×시간의 `예측_승차인원`, `예측_하차인원`
- **후처리:** 음수 클리핑, 단말 정류장 0 강제, 승객 보존(탑승-하차 누적 onboard 제약) 시뮬레이션 적용

## 평가
- **Test MAE:** ~1.34–1.40  
- **Test RMSE:** ~2.37–2.42  
> 단위: 시간×정류장당 인원. (세부 리포트는 `/reports/metrics_*.csv`로 저장 가능)

## 파일 구조(예시)
```
final_project/
├─ data/
│  ├─ raw/  # 원천 csv들
│  ├─ 172_시간대별_정류장_노선_추정승하차+운행횟수+순서+링크거리.csv
│  ├─ 172_LSTM_preds_정류장별_시간별_승하차_예측.csv
│  └─ 172_LSTM_preds_정류장별_시간별_승하차_예측_혼잡도+추가배차.csv
├─ src/
│  ├─ prepare_inputs.py      # 172 필터/조인/분배/클리핑
│  ├─ baseline_LSTM.py       # 데이터셋 생성, 학습, 예측
│  └─ postprocess_capacity.py# 혼잡/배차 산정
└─ README.md
```

## 실행 방법
### 0) 환경
- Python 3.10+
- TensorFlow 2.19.0 (`Physical GPUs: []`라도 CPU로 동작)
- pandas, numpy, scikit-learn

### 1) 입력 준비
```bash
python src/prepare_inputs.py   --passenger_csv ".../승하차_인원_정보(06월)_utf8.csv"   --freq_csv      ".../tpss_sta_route_hturn_merged.csv"   --route_csv     ".../서울시 버스노선 기본정보 항목정보_utf8.csv"   --master_csv    ".../서울시 노선 정류장마스터 정보_utf8.csv"   --route_no 172   --out_csv data/172_시간대별_정류장_노선_추정승하차+운행횟수+순서+링크거리.csv
```

### 2) 학습 & 예측
```bash
python src/baseline_LSTM.py   --input_csv data/172_시간대별_정류장_노선_추정승하차+운행횟수+순서+링크거리.csv   --train_end 2025-06-21 --test_start 2025-06-22 --test_end 2025-06-29   --out_pred data/172_LSTM_preds_정류장별_시간별_승하차_예측.csv
```

### 3) 혼잡/배차 산정
```bash
python src/postprocess_capacity.py   --pred_csv data/172_LSTM_preds_정류장별_시간별_승하차_예측.csv   --capacity 33 --crowded_multiplier 1.5   --out_csv data/172_LSTM_preds_정류장별_시간별_승하차_예측_혼잡도+추가배차.csv
```

## 산출물 스키마
### `...예측.csv`
| 컬럼 | 설명 |
|---|---|
| 기준_날짜 | 예측 일자 |
| 시간 | 0–23 |
| 정류장_ID | 표준 정류장 ID |
| 정류장_순서 | 노선 내 순서 (1부터) |
| 예측_승차인원 / 예측_하차인원 | 음수→0 클리핑, 말단 정류장=0 적용 |
| 역명 | 안내용 |
| 운행횟수 | 해당 시간대 정류장 통과 버스 수(균등분배 기준) |
| 링크_구간거리(m) | 결측 시 노선 평균 |
| 버스당_탑승예측 | 총수요/통과버스수 (후처리 단계에서 계산) |

### `...혼잡도+추가배차.csv` (추가 컬럼)
| 컬럼 | 설명 |
|---|---|
| 총수요 | 시간×정류장의 총 탑승 수요(= 버스당×통과버스수) |
| 필요_총버스 | `ceil(총수요 / (정원×혼잡배수))` |
| 추가_배차 | `max(0, 필요_총버스 - 통과버스수)` |
| 개선후_버스당 | `총수요 / max(통과버스수+추가_배차,1)` |
| 혼잡도 / 혼잡도_개선후 | 여유/보통/혼잡 |

### 결과 예시
<img width="968" height="326" alt="image" src="https://github.com/user-attachments/assets/403f2f9c-7211-4489-8768-25a9e974ac44" />

- 퇴근 시간인 18시부터 혼잡 상태인 버스가 특정 정류장 이후 생기는 것을 확인할 수 있음
- 이는 19시에도 같은 현상이 일어나며, 다른 feature(기상/공휴일/행사 등)을 사용하여 더 정교한 시뮬레이션을 통해 추가 검증할 예정
- 이는 추가 배차를 통해 혼잡도를 낮추고 정시성을 챙겨 시민들의 불만을 없앨 수 있을 것으로 기대
- 특이한 점은 출근 시간에는 혼잡 버스가 이 기간 내에는 일어나지 않음 -> 이 버스만의 특징인지는 데이터셋 확장 이후 확인 가능

## 가정 & 제약
- **균등분배.** 같은 시간대에 통과하는 버스에 동일 수요를 배분.
- **차량 정원:** 33인(서울시 시내버스 기준), **혼잡 기준:** 1.5배(= 49.5명) 초과 시 **혼잡**.
- **음수 예측 제거:** 모델 노이즈 방지 위해 0으로 클리핑.
- **말단 정류장 승객=0:** 종점에서 하차 완료/탑승 없음 가정.
- **연속 onboard 제약:** 하차는 누적 탑승을 초과하지 않도록 시뮬레이션에서 보정.

## Known Issues / 개선 아이디어
- **요일/이벤트 효과:** 공휴일/행사 반영 필요.
- **다른 변수 제외:** 첫번째 프로토 타입이므로 다른 변수는 제외. 다음 시뮬레이션에서 날씨/공휴일/행사 feature를 준 뒤 재시뮬레이션 예정
- **라벨 스무딩:** 극단값 완화.
- **온보드 검증:** 실제 혼잡도 또는 차내 혼잡 센서 데이터와 비교·보정.

## 재현성
- Seed 고정: `numpy`, `random`, `tensorflow` 시드 설정 권장
- Python/패키지 버전 핀ning: `requirements.txt` 제공
